# Eco-Quest Supabase & Gameplay Enhancement – Lessons Learned

## 1. Supabase 연동 및 프로덕션 배포
- **Public 환경변수 필요성**: 브라우저용 Supabase 클라이언트는 `NEXT_PUBLIC_SUPABASE_URL` 및 `NEXT_PUBLIC_SUPABASE_ANON_KEY`가 필요하다. 배포 파이프라인(Netlify 등)에 서버용 값만 넣으면 런타임에서 `undefined`가 되어 연결이 끊김.
- **프록시 라우팅**: Netlify 기본 리다이렉트(`/api/* → /.netlify/functions/*`) 때문에 Next.js API 라우트가 무시될 수 있다. `supabase` 경로는 예외 처리하거나 Next 프록시를 우선 통과시키도록 별도 리다이렉트 규칙을 추가해야 한다.
- **Fallback 전략**: 외부 Supabase 함수가 404/500을 반환할 수 있으므로, 프록시에서 실패 시 로컬 mock 데이터를 반환하도록 설계하면 데모 환경이 안정적이다. 동시에 콘솔 경고로 실패 원인을 추적할 수 있도록 로그를 남긴다.

## 2. 게임 UI/UX 개선
- **정책/환경 패널의 영향**: 정책 슬라이더(`탄소세`, `환경 보조금`, `규제 강도`)를 도입하고 매 틱마다 환경 벡터(대기/수질/생물)와 사회적 비용을 계산해 HUD에 시각화했다. 플레이어가 정책 효과를 즉시 체감하게 만드는 것이 중요하다.
- **이벤트 피드 & 알림**: 버스 시스템(고정된 `eventLogRef`)에 이벤트를 축적하고 `PlayersFeed`에 표시하여, 플레이 도중 어떤 조치가 있었는지 한눈에 확인할 수 있다. 이 방법은 온라인 멀티 경험이나 세션 리플레이에도 활용 가능하다.
- **튜토리얼 온보딩**: 첫 접속 시 핵심 조작 가이드를 모달로 제공하고, 중요 변경사항은 로컬스토리지에 남겨 재방문 시 반복 노출을 방지했다. 튜토리얼 버튼에서 바로 시뮬레이션을 시작하여 학습 → 실습 흐름을 줄였다.

## 3. 시뮬레이션 로직
- **환경 벡터 모델링**: 시설 타입별로 대기/수질/생물에 미치는 월간 영향을 벡터로 계산하고, 최근 30틱(약 1 “게임 월”)을 합산해 `ExternalityLedger`에 시각화했다. 현실적인 밸런스를 위해서는 추후 실제 수치 기반 튜닝이 필요하다.
- **정책 피드백 루프**: 슬라이더 값이 직접 `credits` 및 `ecoScore` 계산에 개입한다. 탄소세는 피해를 줄일수록 유리하고, 보조금은 느리지만 긍정 보상을 제공하며, 규제는 음의 영향에 대응하는 식으로 설계했다.

## 4. 디버깅 & 운영
- **환경변수 로그**: 개발 단계에서는 환경변수를 콘솔에 출력하며 검증했지만, 프로덕션에서는 최소화해야 한다. 현재는 `process.env.NODE_ENV !== "production"` 조건으로 제한함.
- **로컬/원격 후크**: `/api/supabase/functions/*` 요청 시 실패하면 자동으로 로컬 mock data와 알림을 출력해 UX를 유지한다. 향후 실제 함수가 구현되면, 200 응답이 바로 UI에 반영된다.

## 5. 다음번 작업 시 유의점
1. **배포 환경 변수 체계화**: Netlify/AWS 등 배포 환경에 필요한 모든 키(NEXT_PUBLIC 포함)가 자동으로 주입되는지 파이프라인을 설정해, 로컬과 동등한 환경을 유지한다.
2. **리다이렉트 & CDN 규칙**: `/api` 경로 처리 우선순위를 문서화하고, 프록시 용도 API를 추가할 때마다 예외 규칙을 업데이트한다.
3. **Supabase API 모니터링**: `console.warn`만으로는 부족할 수 있으니, 추후 서버 로그/에러 리포트(Sentry 등) 연동을 고려한다.
4. **시뮬레이션 수치 검증**: 현재 환경 벡터 및 정책 수치는 임의 값이다. 밸런싱 작업에 들어갈 때는 `lib/simulations`와 연동하여 테스트 자동화 및 빌드 시 체크를 추가할 계획을 세운다.
5. **튜토리얼 유지 전략**: 대규모 업데이트 시 튜토리얼 메시지를 갱신하고, 로컬스토리지 키 버전을 바꿔 재노출하도록 설계하면 UX 혼란을 줄일 수 있다.

## 6. 링크
- Netlify 배포: https://eco-quest-simulator.netlify.app/
- Supabase 엔드포인트: `http://168.107.47.60:54321`
- 튜토리얼/정책 패널 레이아웃: `app/eco-quest/game/page.tsx`

이번 작업을 통해 Supabase 연동 안정성과 게임 플레이 완성도를 함께 다듬었다. 다음 작업에서는 밸런스 데이터 정제, Supabase 함수 실제 구현, 멀티 플레이 이벤트 피드 검증 등을 순차적으로 진행하면 된다.
